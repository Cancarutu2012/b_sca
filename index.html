<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pázmány-beléptető</title>
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; height: 100vh; display: flex; flex-direction: column; justify-content: space-between; overflow-y: auto; /* Az egész oldal görgethetővé tétele */ }
        #qr-reader { width: 100%; height: 100%; display: block; position: relative; }
        #overlay { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0, 0, 0, 0.5); 
            display: none; 
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        #nameDisplay { font-size: 40px; color: green; font-weight: bold; }
        #message { font-weight: bold; font-size: 18px; color: white; margin-top: 10px; }
        #nameTable { margin-top: 20px; width: 100%; border-collapse: collapse; display: none; }
        #nameTable th, td { border: 1px solid black; padding: 10px; text-align: center; }
        #sendButton { margin-top: 20px; padding: 10px 20px; font-size: 16px; cursor: pointer; background-color: #4CAF50; color: white; border: none; display: none; }
        #sendButton:disabled { background-color: #ccc; }
        #bottomSection { margin-top: 20px; }
    </style>
</head>
<body>

<h2>BELÉPTETŐ RENDSZER</h2>

<div id="qr-reader"></div>

<div id="overlay">
    <div id="nameDisplay" style="display:none;"></div>
    <div id="message" style="display:none;">KÉRLEK, MENJ TOVÁBB</div>
</div>

<div id="bottomSection">
    <table id="nameTable">
        <thead>
            <tr><th>Becsekkolt nevek listája (érkezési sorrendben levezetve)</th></tr>
            <button id="sendButton" onclick="sendEmail()">LISTA KÜLDÉSE</button>
        </thead>
        <tbody id="nameList"></tbody>
    </table>
</div>

<script>
// ------------------- Numerikus mapping -------------------
function decodeName(code) {
    const map = {};
    let i = 1;
    for (let c = "A".charCodeAt(0); c <= "Z".charCodeAt(0); c++) map[i++] = String.fromCharCode(c);
    for (let c = "a".charCodeAt(0); c <= "z".charCodeAt(0); c++) map[i++] = String.fromCharCode(c);
    map[0] = " ";
    map[53] = "-";

    let name = "";
    for (let i = 0; i < code.length; i += 2) {
        const num = parseInt(code.substring(i, i + 2), 10);
        if (map[num]) {
            name += map[num];
        } else {
            name += "?"; // Ha nem található karakter
        }
    }
    return name;
}

// ------------------- QR kód dekódolása -------------------
let scanner;
let nameList = [];
let isScanning = true; // Felvesszük a szkennelés állapotát
let deviceId = localStorage.getItem('deviceId'); // Tároljuk el a kiválasztott kamera ID-ját

function decodeMessage(decodedText) {
    // A vonalkód dekódolása
    const decodedName = decodeName(decodedText.trim());
    if (decodedName) {
        // Nevet zöld színnel megjeleníteni az overlayen
        const nameDisplay = document.getElementById("nameDisplay");
        nameDisplay.textContent = decodedName;
        nameDisplay.style.display = "block";
        document.getElementById("message").style.display = "block";
        document.getElementById("overlay").style.display = "flex";  // Overlay megjelenítése
        
        // Hozzáadjuk a táblázathoz
        const tableBody = document.getElementById("nameList");
        const newRow = document.createElement("tr");
        const newCell = document.createElement("td");
        newCell.textContent = decodedName;
        newRow.appendChild(newCell);
        tableBody.appendChild(newRow);

        // Megjeleníti a táblázatot és a Küld gombot
        document.getElementById("nameTable").style.display = "block";
        document.getElementById("sendButton").style.display = "inline-block";

        // Az overlay eltűnik 2 másodperc múlva, a kamera továbbra is működik
        setTimeout(function() {
            document.getElementById("overlay").style.display = "none";
        }, 2000);
    }
}

// ------------------- E-mail küldés -------------------
function sendEmail() {
    const tableContent = [];
    const rows = document.getElementById("nameList").getElementsByTagName("tr");
    for (let row of rows) {
        tableContent.push(row.innerText.trim()); // Soronként hozzáadjuk a neveket
    }

    const emailSubject = "Beolvasott Nevek";
    const emailBody = `A következő neveket olvastuk be:\n\n${tableContent.join("; ")}`; // Neveket pontosvesszővel elválasztva egy sorban

    window.location.href = `mailto:info@radetzky.hu?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;
}


// ------------------- QR kód olvasó beállítása -------------------
function onScanSuccess(decodedText, decodedResult) {
    if (isScanning) {
        isScanning = false;  // Miután beolvasunk, egy időre megállítjuk a szkennelést
        decodeMessage(decodedText);
        setTimeout(() => {
            isScanning = true;  // Újra engedélyezzük a szkennelést 2 másodperc múlva
        }, 2000);
    }
}

// Kiválasztott kamera tárolása és olvasó indítása
function startScanner() {
    if (!deviceId) {
        // Ha még nincs kamerák ID-ja, kérjük a felhasználót, hogy válasszon
        Html5Qrcode.getCameras().then(devices => {
            if (devices && devices.length) {
                // Első kamera kiválasztása (vagy felhasználó választása)
                deviceId = devices[0].id; // Elmentjük az első kamera ID-ját
                localStorage.setItem('deviceId', deviceId); // Tároljuk el a választott kamera ID-ját
                scanner = new Html5QrcodeScanner("qr-reader", { fps: 10, qrbox: 250, deviceId: deviceId }, false);
                scanner.render(onScanSuccess);
            }
        }).catch(err => {
            console.error("Hiba történt a kamera lekérdezésekor:", err);
        });
    } else {
        // Ha már van eszköz ID, akkor azt használjuk
        scanner = new Html5QrcodeScanner("qr-reader", { fps: 10, qrbox: 250, deviceId: deviceId }, false);
        scanner.render(onScanSuccess);
    }
}

// QR olvasó indítása
startScanner();

</script>

</body>
</html>






